{{- /*
Shortcode: aff

Uso:
  {{< aff title="Filtro HEPA compatible" vendor="amazon" asin="B0XXXXXXX" >}}
  {{< aff title="Batería compatible V8 21.6V" vendor="aliexpress" url="https://www.aliexpress.com/item/100500xxxxx.html" >}}
  {{< aff title="Ver opciones" url="https://..." >}}

Params:
- title  (texto del enlace)
- vendor ("amazon" | "aliexpress" | "" )
- url    (url destino)
- asin   (solo Amazon; genera URL a Amazon ES)
- note   (opcional: pequeño texto bajo el enlace)
*/ -}}

{{- $title := .Get "title" | default "Ver oferta" -}}
{{- $vendor := lower (.Get "vendor" | default "") -}}
{{- $url := .Get "url" | default "" -}}
{{- $asin := .Get "asin" | default "" -}}
{{- $note := .Get "note" | default "" -}}

{{- /* IDs (vacíos por defecto; rellena cuando toque) */ -}}
{{- $amazonTag := site.Params.amazonTag | default "" -}}
{{- $aliPid := site.Params.aliexpressPid | default "" -}}

{{- /* Amazon por ASIN */ -}}
{{- if and (eq $vendor "amazon") (ne $asin "") -}}
  {{- $base := printf "https://www.amazon.es/dp/%s" $asin -}}
  {{- if ne $amazonTag "" -}}
    {{- $url = printf "%s?tag=%s" $base (urlquery $amazonTag) -}}
  {{- else -}}
    {{- $url = $base -}}
  {{- end -}}
{{- end -}}

{{- /* AliExpress: añade tracking SIN parsear URL (evita romper build) */ -}}
{{- if and (eq $vendor "aliexpress") (ne $url "") (ne $aliPid "") -}}
  {{- if in $url "?" -}}
    {{- $url = printf "%s&aff_fcid=%s" $url (urlquery $aliPid) -}}
  {{- else -}}
    {{- $url = printf "%s?aff_fcid=%s" $url (urlquery $aliPid) -}}
  {{- end -}}
{{- end -}}

{{- /* Si al final no hay URL, no renderiza nada */ -}}
{{- if ne $url "" -}}
  <p class="aff">
    <a class="aff__btn" href="{{ $url | safeURL }}" target="_blank" rel="sponsored nofollow noopener">
      {{- $title -}}
    </a>
    {{- if ne $note "" -}}
      <small class="aff__note">{{ $note }}</small>
    {{- end -}}
  </p>
{{- end -}}
