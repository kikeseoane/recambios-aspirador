{{ define "main" }}
  {{ $db := site.Data.aspiradores }}
  {{ $brands := $db.brands }}

  {{ $brandKey := .Params.brandKey }}
  {{ $modelSlug := (or .Params.modelSlug .Params.slug) | urlize }}

  {{ $brand := index $brands $brandKey }}

  {{ if not $brand }}
    <h1>Modelo no disponible</h1>
    <p class="muted">No encontramos la marca asociada a este modelo.</p>
    <div class="chips" style="margin-top:14px;">
      <a class="chip" href="{{ "/marcas/" | relURL }}">Ver marcas</a>
      <a class="chip" href="{{ "/modelos/" | relURL }}">Ver todos los modelos</a>
    </div>
  {{ else }}

    {{/* Buscar el modelo en YAML por slug/canonical/id */}}
    {{ $model := dict }}
    {{ range $m := $brand.models }}
      {{ $mid := (or $m.slug $m.canonical_slug $m.id) | urlize }}
      {{ if eq $mid $modelSlug }}
        {{ $model = $m }}
      {{ end }}
    {{ end }}

    {{ if not (len $model) }}
      <div class="breadcrumbs">
        <a href="{{ "/" | relURL }}">Inicio</a><span class="sep">‚Ä∫</span>
        <a href="{{ "/marcas/" | relURL }}">Marcas</a><span class="sep">‚Ä∫</span>
        <a href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">{{ $brand.name }}</a>
      </div>

      <h1>{{ .Title }}</h1>
      <p class="muted">Estamos terminando de preparar la ficha de este modelo.</p>

      <div class="card" style="margin-top:14px;">
        <h3>Mientras tanto</h3>
        <p class="muted">Puedes volver a la marca y elegir otro modelo disponible.</p>
        <div class="chips" style="margin-top:10px;">
          <a class="chip" href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">Ver modelos {{ $brand.name }}</a>
          <a class="chip" href="{{ "/modelos/" | relURL }}">Todos los modelos</a>
        </div>
      </div>
    {{ else }}

      <div class="breadcrumbs">
        <a href="{{ "/" | relURL }}">Inicio</a><span class="sep">‚Ä∫</span>
        <a href="{{ "/marcas/" | relURL }}">Marcas</a><span class="sep">‚Ä∫</span>
        <a href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">{{ $brand.name }}</a><span class="sep">‚Ä∫</span>
        <span>{{ $brand.name }} {{ $model.model }}</span>
      </div>

      <div class="hero" style="margin-top:10px;">
        <div class="kicker">Modelo</div>
        <h1>{{ $brand.name }} {{ $model.model }}</h1>
        {{ with $model.intro }}<p class="muted">{{ . }}</p>{{ end }}

        <div class="chips">
          {{ with $model.series }}<span class="chip active">Serie {{ . }}</span>{{ end }}
          {{ with $model.year_range }}<span class="chip">{{ . }}</span>{{ end }}
          <a class="chip" href="{{ "/guias/compra/" | relURL }}">C√≥mo elegir recambio</a>
          <a class="chip" href="{{ "/guias/mantenimiento/" | relURL }}">Mantenimiento</a>
          <a class="chip" href="{{ "/guias/seguridad/" | relURL }}">Seguridad</a>
        </div>
      </div>

      <div class="two-col" style="margin-top:12px;">
        <div class="panel">
          <h2 style="margin-top:0;">Compatibilidad r√°pida</h2>

          {{ if $model.compatibilidad }}
            <ul class="list">
              {{ range $model.compatibilidad }}<li>{{ . }}</li>{{ end }}
            </ul>
          {{ else }}
            <p class="muted">Consejo: confirma variante exacta (Animal/Absolute/etc.) y compara encajes en el anuncio.</p>
          {{ end }}

          <hr>

          <h2 style="margin-top:0;">Recambios compatibles</h2>
          <p class="muted small">Enlaces directos a tiendas externas. Verifica compatibilidad exacta antes de comprar.</p>

          {{ $cats := $db.globals.categorias_recambios }}
          {{ range $cat := $cats }}
            {{ $items := index $model.recambios $cat.key }}

            {{ if $items }}
              <h2 style="margin-bottom:8px;">{{ $cat.label }}</h2>

              <div class="products">
                {{ range $it := $items }}
                  <div class="product">
                    <div class="img">{{ $cat.icon | default "üß©" }}</div>

                    <div class="body">
                      <div class="title">{{ $it.title }}</div>

                      {{ $cur := or $it.currency "EUR" }}
                      {{ if or $it.price_from $it.price_to }}
                        <div class="price">
                          <span class="now">
                            {{ if $it.price_from }}{{ printf "%.2f" $it.price_from }}{{ end }}
                            {{ if and $it.price_from $it.price_to }}‚Äì{{ end }}
                            {{ if $it.price_to }}{{ printf "%.2f" $it.price_to }}{{ end }}
                            {{ $cur }}
                          </span>
                        </div>
                      {{ end }}

                      <div class="meta-row">
                        {{ if $it.rating }}<span class="star">‚òÖ {{ $it.rating }}</span>{{ end }}
                        {{ if $it.reviews }}<span class="muted">{{ $it.reviews }} rese√±as</span>{{ end }}
                      </div>

                      {{ if $it.badges }}
                        <div class="badges" style="margin-top:10px;">
                          {{ range $b := $it.badges }}
                            <span class="badge">{{ $b }}</span>
                          {{ end }}
                        </div>
                      {{ end }}

                      {{ with $it.note }}
                        <div class="note muted" style="margin-top:10px;">{{ . }}</div>
                      {{ end }}

                      <div class="cta">
                        <a class="btn-buy" href="{{ $it.url }}" rel="nofollow sponsored" target="_blank">Ver oferta</a>
                      </div>
                    </div>
                  </div>
                {{ end }}
              </div>

            {{ else }}
              {{/* No mostramos todas las categor√≠as vac√≠as para no hacer ‚Äúthin UI‚Äù */}}
            {{ end }}
          {{ end }}

          {{/* Si no hay recambios en ninguna categor√≠a, mostramos un bloque √∫nico */}}
          {{ $hasAny := false }}
          {{ range $cat := $cats }}
            {{ if (index $model.recambios $cat.key) }}{{ $hasAny = true }}{{ end }}
          {{ end }}

          {{ if not $hasAny }}
            <div class="card" style="margin-top:14px;">
              <h3>Recambios en preparaci√≥n</h3>
              <p class="muted">Estamos preparando enlaces y compatibilidades para este modelo. Vuelve en breve.</p>
            </div>
          {{ end }}

          <hr>

          <h2 style="margin-top:0;">Fallos comunes y checks</h2>
          {{ if $model.fallos }}
            <div class="grid cols-2">
              {{ range $f := $model.fallos }}
                <div class="panel">
                  <div class="badge warn">S√≠ntoma</div>
                  <h3 style="margin:10px 0 8px;">{{ $f.symptom }}</h3>

                  {{ if $f.causas }}
                    <div class="kicker">Causas probables</div>
                    <ul>
                      {{ range $f.causas }}<li>{{ . }}</li>{{ end }}
                    </ul>
                  {{ end }}

                  {{ if $f.checks }}
                    <div class="kicker">C√≥mo comprobar</div>
                    <ul>
                      {{ range $f.checks }}<li>{{ . }}</li>{{ end }}
                    </ul>
                  {{ end }}

                  {{ with $f.fix_hint }}
                    <p class="muted small" style="margin-top:10px;">{{ . }}</p>
                  {{ end }}
                </div>
              {{ end }}
            </div>
          {{ else }}
            <p class="muted">Aqu√≠ iremos a√±adiendo los fallos m√°s t√≠picos y las comprobaciones r√°pidas.</p>
          {{ end }}
        </div>

        <aside class="panel">
          <h2 style="margin-top:0;">Antes de comprar</h2>
          <p class="muted small">Checklist r√°pida para evitar incompatibilidades.</p>

          {{ $g := $db.globals.guias_genericas }}
          <div class="panel" style="box-shadow:none;background:#fff;border-style:dashed;">
            <div class="kicker">{{ $g.compra.title }}</div>
            <ul class="small">
              {{ range $g.compra.bullets }}<li>{{ . }}</li>{{ end }}
            </ul>
          </div>

          <div style="margin-top:12px;">
            <div class="kicker">Atajos</div>
            <div class="chips">
              <a class="chip" href="{{ "/marcas/" | relURL }}">M√°s marcas</a>
              <a class="chip" href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">M√°s modelos {{ $brand.name }}</a>
              <a class="chip" href="{{ "/modelos/" | relURL }}">Todos los modelos</a>
            </div>
          </div>

          <hr>

          <div class="kicker">Transparencia</div>
          <p class="muted small">Algunos enlaces pueden ser de afiliaci√≥n. Precio y disponibilidad dependen del vendedor.</p>
        </aside>
      </div>

    {{ end }}
  {{ end }}
{{ end }}
