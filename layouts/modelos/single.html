{{ define "main" }}
  {{ $db := site.Data.aspiradores }}
  {{ $brands := $db.brands }}

  {{ $brandKey := .Params.brandKey }}
  {{ $modelSlug := (or .Params.modelSlug .Params.slug) | urlize }}

  {{ $brand := cond (and $brands $brandKey) (index $brands $brandKey) nil }}

  {{ if not $brand }}
    <h1>Modelo no disponible</h1>
    <p class="muted">No encontramos la marca asociada a este modelo.</p>
    <div class="chips" style="margin-top:14px;">
      <a class="chip" href="{{ "/marcas/" | relURL }}">Ver marcas</a>
      <a class="chip" href="{{ "/modelos/" | relURL }}">Ver todos los modelos</a>
    </div>

  {{ else }}

    {{/* Buscar modelo en YAML */}}
    {{ $model := dict }}
    {{ $models := $brand.models }}

    {{ if and $models (reflect.IsSlice $models) }}
      {{ range $m := $models }}
        {{ $mid := (or (index $m "slug") (index $m "canonical_slug") (index $m "id")) | urlize }}
        {{ if eq $mid $modelSlug }}
          {{ $model = $m }}
        {{ end }}
      {{ end }}
    {{ end }}

    {{ if not (len $model) }}
      <div class="breadcrumbs">
        <a href="{{ "/" | relURL }}">Inicio</a><span class="sep">‚Ä∫</span>
        <a href="{{ "/marcas/" | relURL }}">Marcas</a><span class="sep">‚Ä∫</span>
        <a href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">{{ $brand.name }}</a>
      </div>

      <h1>{{ .Title }}</h1>
      <p class="muted">Estamos terminando de preparar la ficha de este modelo.</p>

      <div class="card" style="margin-top:14px;">
        <h3>Mientras tanto</h3>
        <p class="muted">Puedes volver a la marca y elegir otro modelo disponible.</p>
        <div class="chips" style="margin-top:10px;">
          <a class="chip" href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">Ver modelos {{ $brand.name }}</a>
          <a class="chip" href="{{ "/modelos/" | relURL }}">Todos los modelos</a>
        </div>
      </div>

    {{ else }}

      <div class="breadcrumbs">
        <a href="{{ "/" | relURL }}">Inicio</a><span class="sep">‚Ä∫</span>
        <a href="{{ "/marcas/" | relURL }}">Marcas</a><span class="sep">‚Ä∫</span>
        <a href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">{{ $brand.name }}</a><span class="sep">‚Ä∫</span>
        <span>{{ $brand.name }} {{ index $model "model" }}</span>
      </div>

      <div class="hero" style="margin-top:10px;">
        <div class="kicker">Modelo</div>
        <h1>{{ $brand.name }} {{ index $model "model" }}</h1>
        {{ with (index $model "intro") }}<p class="muted">{{ . }}</p>{{ end }}

        <div class="chips">
          {{ with (index $model "series") }}<span class="chip active">Serie {{ . }}</span>{{ end }}
          {{ with (index $model "year_range") }}<span class="chip">{{ . }}</span>{{ end }}
          <a class="chip" href="{{ "/guias/compra/" | relURL }}">C√≥mo elegir recambio</a>
          <a class="chip" href="{{ "/guias/mantenimiento/" | relURL }}">Mantenimiento</a>
          <a class="chip" href="{{ "/guias/seguridad/" | relURL }}">Seguridad</a>
        </div>
      </div>

      <div class="two-col" style="margin-top:12px;">
        <div class="panel">
          <h2 style="margin-top:0;">Compatibilidad r√°pida</h2>

          {{ $compat := index $model "compatibilidad" }}
          {{ if $compat }}
            {{ if reflect.IsSlice $compat }}
              <ul class="list">
                {{ range $compat }}<li>{{ . }}</li>{{ end }}
              </ul>
            {{ else }}
              <p class="muted">{{ $compat }}</p>
            {{ end }}
          {{ else }}
            <p class="muted">Consejo: confirma variante exacta (Animal/Absolute/etc.) y compara encajes en el anuncio.</p>
          {{ end }}

          <hr>

          <h2 style="margin-top:0;">Recambios compatibles</h2>
          <p class="muted small">Verifica compatibilidad exacta (conectores, encaje y voltaje) antes de comprar.</p>

          {{ $cats := $db.globals.categorias_recambios }}
          {{ $rec := index $model "recambios" }}

          {{ if and $cats (reflect.IsSlice $cats) (and $rec (reflect.IsMap $rec)) }}
            {{ range $cat := $cats }}
              {{ $catKey := index $cat "key" }}
              {{ $catLabel := index $cat "label" }}
              {{ $catIcon := index $cat "icon" }}

              {{ $items := index $rec $catKey }}
              {{ if $items }}
                <h2 style="margin-bottom:8px;">{{ $catLabel }}</h2>

                <div class="products">
                  {{ if reflect.IsSlice $items }}
                    {{ range $it := $items }}
                      <div class="product">
                        <div class="img">{{ $catIcon | default "üß©" }}</div>

                        <div class="body">
                          <div class="title">{{ index $it "title" }}</div>

                          {{ with (index $it "note") }}
                            <div class="note muted" style="margin-top:10px;">{{ . }}</div>
                          {{ end }}

                          <div class="cta">
                            {{ $sku := index $it "sku" }}
                            {{ partial "offer_btn.html" (dict "sku" $sku "label" "Ver oferta" "class" "btn-buy") }}
                          </div>
                        </div>
                      </div>
                    {{ end }}
                  {{ else }}
                    <div class="card">
                      <p class="muted">Formato de recambios incorrecto (se esperaba una lista).</p>
                    </div>
                  {{ end }}
                </div>
              {{ end }}
            {{ end }}
          {{ else }}
            <p class="muted">A√∫n no hay recambios cargados para este modelo.</p>
          {{ end }}

          <hr>

          <h2 style="margin-top:0;">Fallos comunes y checks</h2>

          {{ $fallos := index $model "fallos" }}
          {{ if $fallos }}
            {{ if reflect.IsSlice $fallos }}
              <div class="grid cols-2">
                {{ range $f := $fallos }}
                  <div class="panel">
                    <div class="badge warn">S√≠ntoma</div>
                    <h3 style="margin:10px 0 8px;">{{ index $f "symptom" }}</h3>

                    {{ $causas := index $f "causas" }}
                    {{ if $causas }}
                      <div class="kicker">Causas probables</div>
                      {{ if reflect.IsSlice $causas }}
                        <ul>
                          {{ range $causas }}<li>{{ . }}</li>{{ end }}
                        </ul>
                      {{ else }}
                        <p class="muted">{{ $causas }}</p>
                      {{ end }}
                    {{ end }}

                    {{ $checks := index $f "checks" }}
                    {{ if $checks }}
                      <div class="kicker">C√≥mo comprobar</div>
                      {{ if reflect.IsSlice $checks }}
                        <ul>
                          {{ range $checks }}<li>{{ . }}</li>{{ end }}
                        </ul>
                      {{ else }}
                        <p class="muted">{{ $checks }}</p>
                      {{ end }}
                    {{ end }}

                    {{ with (index $f "fix_hint") }}
                      <p class="muted small" style="margin-top:10px;">{{ . }}</p>
                    {{ end }}
                  </div>
                {{ end }}
              </div>
            {{ else }}
              <p class="muted">{{ $fallos }}</p>
            {{ end }}
          {{ else }}
            <p class="muted">Iremos a√±adiendo los fallos m√°s t√≠picos y comprobaciones r√°pidas.</p>
          {{ end }}
        </div>

        <aside class="panel">
        {{/* === ASIDE: Antes de comprar === */}}
        <h2 style="margin-top:0;">Antes de comprar</h2>
        <p class="muted small">Checklist r√°pida para evitar incompatibilidades.</p>

        {{ $compra := partial "get_guia.html" (dict "db" $db "key" "compra") }}

        <div class="panel" style="box-shadow:none;background:#fff;border-style:dashed;">
          {{ if $compra }}

            {{/* Caso 1: compra es LISTA de strings (tu YAML actual) */}}
            {{ if reflect.IsSlice $compra }}
              <div class="kicker">C√≥mo elegir recambio compatible</div>
              <ul class="small">
                {{ range $compra }}<li>{{ . }}</li>{{ end }}
              </ul>

            {{/* Caso 2: compra es MAP {title, bullets} (si migras en el futuro) */}}
            {{ else if reflect.IsMap $compra }}
              {{ with (index $compra "title") }}<div class="kicker">{{ . }}</div>{{ end }}

              {{ $bullets := index $compra "bullets" }}
              {{ if $bullets }}
                {{ if reflect.IsSlice $bullets }}
                  <ul class="small">
                    {{ range $bullets }}<li>{{ . }}</li>{{ end }}
                  </ul>
                {{ else }}
                  <p class="muted small">{{ $bullets }}</p>
                {{ end }}
              {{ else }}
                <p class="muted small">Revisa modelo exacto, encajes y pol√≠tica de devoluci√≥n.</p>
              {{ end }}

            {{ else }}
              <div class="kicker">C√≥mo elegir recambio compatible</div>
              <p class="muted small">Revisa modelo exacto, encajes y pol√≠tica de devoluci√≥n.</p>
            {{ end }}

          {{ else }}
            <div class="kicker">C√≥mo elegir recambio compatible</div>
            <p class="muted small">Revisa modelo exacto, encajes y pol√≠tica de devoluci√≥n.</p>
          {{ end }}
        </div>

          <div style="margin-top:12px;">
            <div class="kicker">Atajos</div>
            <div class="chips">
              <a class="chip" href="{{ "/marcas/" | relURL }}">M√°s marcas</a>
              <a class="chip" href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">M√°s modelos {{ $brand.name }}</a>
              <a class="chip" href="{{ "/modelos/" | relURL }}">Todos los modelos</a>
            </div>
          </div>

          <hr>

          <div class="kicker">Transparencia</div>
          <p class="muted small">Algunos enlaces pueden ser de afiliaci√≥n. Precio y disponibilidad dependen del vendedor.</p>
        </aside>
      </div>

    {{ end }}
  {{ end }}
{{ end }}
