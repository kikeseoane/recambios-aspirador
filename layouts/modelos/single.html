{{ define "main" }}
  {{ $db := site.Data.aspiradores }}
  {{ $brandKey := .Params.brandKey }}
  {{ $modelId := .Params.modelId }}
  {{ $brand := index $db.brands $brandKey }}

  {{/* Buscar el modelo en YAML por id/slug */}}
  {{ $model := dict }}
  {{ range $m := $brand.models }}
    {{ $mid := or $m.id $m.slug }}
    {{ if eq ($mid | urlize) ($modelId | urlize) }}{{ $model = $m }}{{ end }}
  {{ end }}

  <div class="breadcrumbs">
    <a href="{{ "/" | relURL }}">Inicio</a><span class="sep">‚Ä∫</span>
    <a href="{{ "/marcas/" | relURL }}">Marcas</a><span class="sep">‚Ä∫</span>
    <a href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">{{ $brand.name }}</a><span class="sep">‚Ä∫</span>
    <span>{{ $brand.name }} {{ $model.model }}</span>
  </div>

  <div class="hero" style="margin-top:10px;">
    <div class="kicker">Modelo</div>
    <h1>{{ $brand.name }} {{ $model.model }}</h1>
    {{ with $model.intro }}<p class="muted">{{ . }}</p>{{ end }}
    <div class="chips">
      {{ with $model.series }}<span class="chip active">Serie {{ . }}</span>{{ end }}
      <a class="chip" href="{{ "/guias/compra/" | relURL }}">C√≥mo elegir recambio</a>
      <a class="chip" href="{{ "/guias/mantenimiento/" | relURL }}">Mantenimiento</a>
      <a class="chip" href="{{ "/guias/seguridad/" | relURL }}">Seguridad</a>
    </div>
  </div>

  <div class="two-col" style="margin-top:12px;">
    <div class="panel">
      <h2 style="margin-top:0;">Compatibilidad (r√°pido)</h2>
      {{ if $model.compatibilidad }}
        <ul>
          {{ range $model.compatibilidad }}<li>{{ . }}</li>{{ end }}
        </ul>
      {{ else }}
        <p class="muted">A√±ade compatibilidad en el YAML para este modelo.</p>
      {{ end }}

      <hr>

      <h2 style="margin-top:0;">Recambios compatibles</h2>
      <p class="muted small">Apariencia ‚Äúmarketplace‚Äù: bot√≥n directo + notas. Verifica compatibilidad exacta antes de comprar.</p>

      {{ $cats := $db.globals.categorias_recambios }}
      {{ range $cat := $cats }}
        {{ $items := index $model.recambios $cat.key }}

        <h2 style="margin-bottom:8px;">{{ $cat.label }}</h2>

        {{ if $items }}
          <div class="products">
            {{ range $it := $items }}
              <div class="product">
                <div class="img">{{ $cat.icon | default "üß©" }}</div>

                <div class="body">
                  <div class="title">{{ $it.title }}</div>

                  {{/* Precio desde/hasta */}}
                  {{ $cur := or $it.currency ($db.globals.site.currency_default) "EUR" }}
                  {{ if or $it.price_from $it.price_to }}
                    <div class="price">
                      <span class="now">
                        {{ if $it.price_from }}{{ printf "%.2f" $it.price_from }}{{ end }}
                        {{ if and $it.price_from $it.price_to }}‚Äì{{ end }}
                        {{ if $it.price_to }}{{ printf "%.2f" $it.price_to }}{{ end }}
                        {{ $cur }}
                      </span>
                      <span class="range muted" style="margin-left:8px;">
                        {{ if and $it.price_from (not $it.price_to) }}desde{{ end }}
                        {{ if and (not $it.price_from) $it.price_to }}hasta{{ end }}
                      </span>
                    </div>
                  {{ else }}
                    <div class="vendor muted">
                      {{ $it.vendor | default "Tienda externa" }}
                    </div>
                  {{ end }}

                  <div class="meta-row">
                    {{ if $it.rating }}<span class="star">‚òÖ {{ $it.rating }}</span>{{ end }}
                    {{ if $it.reviews }}<span class="muted">{{ $it.reviews }} rese√±as</span>{{ end }}
                  </div>

                  {{ if $it.badges }}
                    <div class="badges" style="margin-top:10px;">
                      {{ range $b := $it.badges }}
                        <span class="badge">{{ $b }}</span>
                      {{ end }}
                    </div>
                  {{ end }}

                  {{ with $it.note }}<div class="note muted" style="margin-top:10px;">{{ . }}</div>{{ end }}

                  <div class="cta">
                    <a class="btn-buy" href="{{ $it.url }}" rel="nofollow sponsored" target="_blank">Ver oferta</a>
                  </div>
                </div>
              </div>
            {{ end }}
          </div>
        {{ else }}
          <div class="panel" style="box-shadow:none;background:#fff;border-style:dashed;">
            <p class="muted">A√∫n no hay enlaces para {{ $cat.label }}.</p>
          </div>
        {{ end }}
      {{ end }}

      <hr>

      <h2 style="margin-top:0;">Fallos comunes y checks</h2>
      {{ if $model.fallos }}
        <div class="grid cols-2">
          {{ range $f := $model.fallos }}
            <div class="panel">
              <div class="badge warn">S√≠ntoma</div>
              <h3 style="margin:10px 0 8px;">{{ $f.symptom }}</h3>

              <div class="kicker">Causas probables</div>
              <ul>
                {{ range $f.causas }}<li>{{ . }}</li>{{ end }}
              </ul>

              <div class="kicker">C√≥mo comprobar</div>
              <ul>
                {{ range $f.checks }}<li>{{ . }}</li>{{ end }}
              </ul>

              {{ with $f.fix_hint }}
                <p class="muted small" style="margin-top:10px;">{{ . }}</p>
              {{ end }}
            </div>
          {{ end }}
        </div>
      {{ else }}
        <p class="muted">A√±ade fallos en el YAML para este modelo.</p>
      {{ end }}
    </div>

    <aside class="panel">
      <h2 style="margin-top:0;">Antes de comprar</h2>
      <p class="muted small">Para que el usuario sienta que aqu√≠ ya est√° toda la info cr√≠tica.</p>

      {{ $g := $db.globals.guias_genericas }}
      <div class="panel" style="box-shadow:none;background:#fff;border-style:dashed;">
        <div class="kicker">{{ $g.compra.title }}</div>
        <ul class="small">
          {{ range $g.compra.bullets }}<li>{{ . }}</li>{{ end }}
        </ul>
      </div>

      <div style="margin-top:12px;">
        <div class="kicker">Atajos</div>
        <div class="chips">
          <a class="chip" href="{{ "/marcas/" | relURL }}">M√°s marcas</a>
          <a class="chip" href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">M√°s modelos {{ $brand.name }}</a>
          <a class="chip" href="{{ "/modelos/" | relURL }}">Todos los modelos</a>
        </div>
      </div>

      <hr>

      <div class="kicker">Transparencia</div>
      <p class="muted small">Los enlaces pueden ser de afiliaci√≥n. El precio/disponibilidad dependen del vendedor.</p>
    </aside>
  </div>
{{ end }}
