{{ define "main" }}
  {{ $db := site.Data.aspiradores }}
  {{ $brands := $db.brands }}

  {{ $brandKey := .Params.brandKey }}
  {{ $modelSlug := (or .Params.modelSlug .Params.slug) | urlize }}

  {{ $brand := index $brands $brandKey }}

  {{ if not $brand }}
    <h1>Modelo no disponible</h1>
    <p class="muted">No encontramos la marca asociada a este modelo.</p>
    <div class="chips" style="margin-top:14px;">
      <a class="chip" href="{{ "/marcas/" | relURL }}">Ver marcas</a>
      <a class="chip" href="{{ "/modelos/" | relURL }}">Ver todos los modelos</a>
    </div>

  {{ else }}

    {{/* Buscar modelo en YAML */}}
    {{ $model := dict }}
    {{ $models := $brand.models }}

    {{ if and $models (eq (printf "%T" $models) "[]interface {}") }}
      {{ range $m := $models }}
        {{ $mid := (or (index $m "slug") (index $m "canonical_slug") (index $m "id")) | urlize }}
        {{ if eq $mid $modelSlug }}
          {{ $model = $m }}
        {{ end }}
      {{ end }}
    {{ end }}

    {{ if not (len $model) }}
      <div class="breadcrumbs">
        <a href="{{ "/" | relURL }}">Inicio</a><span class="sep">‚Ä∫</span>
        <a href="{{ "/marcas/" | relURL }}">Marcas</a><span class="sep">‚Ä∫</span>
        <a href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">{{ $brand.name }}</a>
      </div>

      <h1>{{ .Title }}</h1>
      <p class="muted">Estamos terminando de preparar la ficha de este modelo.</p>

      <div class="card" style="margin-top:14px;">
        <h3>Mientras tanto</h3>
        <p class="muted">Puedes volver a la marca y elegir otro modelo disponible.</p>
        <div class="chips" style="margin-top:10px;">
          <a class="chip" href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">Ver modelos {{ $brand.name }}</a>
          <a class="chip" href="{{ "/modelos/" | relURL }}">Todos los modelos</a>
        </div>
      </div>

    {{ else }}

      <div class="breadcrumbs">
        <a href="{{ "/" | relURL }}">Inicio</a><span class="sep">‚Ä∫</span>
        <a href="{{ "/marcas/" | relURL }}">Marcas</a><span class="sep">‚Ä∫</span>
        <a href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">{{ $brand.name }}</a><span class="sep">‚Ä∫</span>
        <span>{{ $brand.name }} {{ index $model "model" }}</span>
      </div>

      <div class="hero" style="margin-top:10px;">
        <div class="kicker">Modelo</div>
        <h1>{{ $brand.name }} {{ index $model "model" }}</h1>
        {{ with (index $model "intro") }}<p class="muted">{{ . }}</p>{{ end }}

        <div class="chips">
          {{ with (index $model "series") }}<span class="chip active">Serie {{ . }}</span>{{ end }}
          {{ with (index $model "year_range") }}<span class="chip">{{ . }}</span>{{ end }}
          <a class="chip" href="{{ "/guias/compra/" | relURL }}">C√≥mo elegir recambio</a>
          <a class="chip" href="{{ "/guias/mantenimiento/" | relURL }}">Mantenimiento</a>
          <a class="chip" href="{{ "/guias/seguridad/" | relURL }}">Seguridad</a>
        </div>
      </div>

      <div class="two-col" style="margin-top:12px;">
        <div class="panel">
          <h2 style="margin-top:0;">Compatibilidad r√°pida</h2>

          {{ $compat := index $model "compatibilidad" }}
          {{ if $compat }}
            {{ if eq (printf "%T" $compat) "[]interface {}" }}
              <ul class="list">
                {{ range $compat }}<li>{{ . }}</li>{{ end }}
              </ul>
            {{ else }}
              <p class="muted">{{ $compat }}</p>
            {{ end }}
          {{ else }}
            <p class="muted">Consejo: confirma variante exacta (Animal/Absolute/etc.) y compara encajes en el anuncio.</p>
          {{ end }}

          <hr>

          <h2 style="margin-top:0;">Recambios compatibles</h2>
          <p class="muted small">Enlaces a AliExpress (externo). Verifica compatibilidad exacta antes de comprar.</p>

          {{ $cats := $db.globals.categorias_recambios }}
          {{ $rec := index $model "recambios" }}

          {{ if and $cats (eq (printf "%T" $cats) "[]interface {}") (and $rec (eq (printf "%T" $rec) "map[string]interface {}")) }}
            {{ range $cat := $cats }}
              {{ $catKey := index $cat "key" }}
              {{ $catLabel := index $cat "label" }}
              {{ $catIcon := index $cat "icon" }}

              {{ $items := index $rec $catKey }}
              {{ if $items }}
                <h2 style="margin-bottom:8px;">{{ $catLabel }}</h2>

                <div class="products">
                  {{ if eq (printf "%T" $items) "[]interface {}" }}
                    {{ range $it := $items }}
                      <div class="product">
                        <div class="img">{{ $catIcon | default "üß©" }}</div>

                        <div class="body">
                          <div class="title">{{ index $it "title" }}</div>

                          {{ with (index $it "note") }}
                            <div class="note muted" style="margin-top:10px;">{{ . }}</div>
                          {{ end }}

                          <div class="cta">
                            {{/* Migraci√≥n SKU: si existe sku lo mostramos; si existe url, link */}}
                            {{ if (index $it "url") }}
                              <a class="btn-buy" href="{{ index $it "url" }}" rel="nofollow sponsored" target="_blank">Ver en AliExpress</a>
                            {{ else if (index $it "sku") }}
                              <span class="badge">SKU: {{ index $it "sku" }}</span>
                            {{ else }}
                              <span class="badge">En preparaci√≥n</span>
                            {{ end }}
                          </div>
                        </div>
                      </div>
                    {{ end }}
                  {{ else }}
                    <div class="card">
                      <p class="muted">Recambios mal formateados en YAML (esperaba lista).</p>
                    </div>
                  {{ end }}
                </div>
              {{ end }}
            {{ end }}
          {{ end }}

          <hr>

          <h2 style="margin-top:0;">Fallos comunes y checks</h2>

          {{ $fallos := index $model "fallos" }}
          {{ if $fallos }}
            {{ if eq (printf "%T" $fallos) "[]interface {}" }}
              <div class="grid cols-2">
                {{ range $f := $fallos }}
                  <div class="panel">
                    <div class="badge warn">S√≠ntoma</div>
                    <h3 style="margin:10px 0 8px;">{{ index $f "symptom" }}</h3>

                    {{ $causas := index $f "causas" }}
                    {{ if $causas }}
                      <div class="kicker">Causas probables</div>
                      {{ if eq (printf "%T" $causas) "[]interface {}" }}
                        <ul>
                          {{ range $causas }}<li>{{ . }}</li>{{ end }}
                        </ul>
                      {{ else }}
                        <p class="muted">{{ $causas }}</p>
                      {{ end }}
                    {{ end }}

                    {{ $checks := index $f "checks" }}
                    {{ if $checks }}
                      <div class="kicker">C√≥mo comprobar</div>
                      {{ if eq (printf "%T" $checks) "[]interface {}" }}
                        <ul>
                          {{ range $checks }}<li>{{ . }}</li>{{ end }}
                        </ul>
                      {{ else }}
                        <p class="muted">{{ $checks }}</p>
                      {{ end }}
                    {{ end }}

                    {{ with (index $f "fix_hint") }}
                      <p class="muted small" style="margin-top:10px;">{{ . }}</p>
                    {{ end }}
                  </div>
                {{ end }}
              </div>
            {{ else }}
              <p class="muted">{{ $fallos }}</p>
            {{ end }}
          {{ else }}
            <p class="muted">Aqu√≠ iremos a√±adiendo los fallos m√°s t√≠picos y las comprobaciones r√°pidas.</p>
          {{ end }}
        </div>

        <aside class="panel">
          <h2 style="margin-top:0;">Antes de comprar</h2>
          <p class="muted small">Checklist r√°pida para evitar incompatibilidades.</p>

          {{ $gg := $db.globals.guias_genericas }}
          {{ $compra := "" }}
          {{ $compraObj := "" }}

          {{ if $gg }}
            {{ $t := printf "%T" $gg }}

            {{ if eq $t "map[string]interface {}" }}
              {{ $compra = index $gg "compra" }}

            {{ else if eq $t "[]interface {}" }}
              {{ range $it := $gg }}
                {{ if and (eq (printf "%T" $it) "map[string]interface {}") (eq (index $it "key") "compra") }}
                  {{ $compra = $it }}
                {{ end }}
              {{ end }}
            {{ end }}
          {{ end }}

          {{/* Normaliza: compraObj debe ser map, no slice */}}
          {{ if $compra }}
            {{ $ct := printf "%T" $compra }}
            {{ if eq $ct "map[string]interface {}" }}
              {{ $compraObj = $compra }}
            {{ else if eq $ct "[]interface {}" }}
              {{ if gt (len $compra) 0 }}
                {{ $first := index $compra 0 }}
                {{ if eq (printf "%T" $first) "map[string]interface {}" }}
                  {{ $compraObj = $first }}
                {{ end }}
              {{ end }}
            {{ end }}
          {{ end }}

          <div class="panel" style="box-shadow:none;background:#fff;border-style:dashed;">
            {{ if $compraObj }}
              {{ with (index $compraObj "title") }}<div class="kicker">{{ . }}</div>{{ end }}

              {{ $bullets := index $compraObj "bullets" }}
              {{ if $bullets }}
                {{ if eq (printf "%T" $bullets) "[]interface {}" }}
                  <ul class="small">
                    {{ range $bullets }}<li>{{ . }}</li>{{ end }}
                  </ul>
                {{ else }}
                  <p class="muted small">{{ $bullets }}</p>
                {{ end }}
              {{ end }}
            {{ else }}
              <div class="kicker">C√≥mo elegir recambio compatible</div>
              <p class="muted small">Revisa modelo exacto, encajes y pol√≠tica de devoluci√≥n.</p>
            {{ end }}
          </div>

          <div style="margin-top:12px;">
            <div class="kicker">Atajos</div>
            <div class="chips">
              <a class="chip" href="{{ "/marcas/" | relURL }}">M√°s marcas</a>
              <a class="chip" href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">M√°s modelos {{ $brand.name }}</a>
              <a class="chip" href="{{ "/modelos/" | relURL }}">Todos los modelos</a>
            </div>
          </div>

          <hr>

          <div class="kicker">Transparencia</div>
          <p class="muted small">Algunos enlaces pueden ser de afiliaci√≥n. Precio y disponibilidad dependen del vendedor.</p>
        </aside>
      </div>

    {{ end }}
  {{ end }}
{{ end }}
