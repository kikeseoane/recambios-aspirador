{{/* layouts/modelos/recambio.html */}}
{{ define "main" }}
  {{ $db := site.Data.aspiradores }}
  {{ $brands := $db.brands }}

  {{ $brandKey := .Params.brandKey | default "" }}
  {{ $modelSlug := (or .Params.modelSlug .Params.slug) | urlize }}
  {{ $catKey := (.Params.catKey | default "" | urlize) }}

  {{ $brand := cond (and $brands $brandKey) (index $brands $brandKey) nil }}

  {{ if not $brand }}
    {{ .Scratch.Set "noindex" true }}
    <h1>Modelo no disponible</h1>
    <p class="muted">No encontramos la marca asociada.</p>
    <a class="chip" href="{{ "/modelos/" | relURL }}">Ver modelos</a>
    {{ return }}
  {{ end }}

  {{/* Buscar modelo en YAML */}}
  {{ $model := dict }}
  {{ range $m := ($brand.models | default (slice)) }}
    {{ $mid := (or (index $m "slug") (index $m "canonical_slug") (index $m "id")) | urlize }}
    {{ if eq $mid $modelSlug }}{{ $model = $m }}{{ end }}
  {{ end }}

  {{ if not (len $model) }}
    {{ .Scratch.Set "noindex" true }}
    <h1>Modelo en preparaciÃ³n</h1>
    <p class="muted">No encontramos el modelo en el catÃ¡logo.</p>
    <a class="chip" href="{{ (printf "/marcas/%s/" ($brandKey|urlize)) | relURL }}">Volver a {{ $brand.name }}</a>
    {{ return }}
  {{ end }}

  {{ $mtitle := partial "model_title.html" (dict "brandName" $brand.name "modelName" (index $model "model")) }}
  {{ if not $mtitle }}{{ $mtitle = $modelSlug }}{{ end }}

  {{ if not $catKey }}
    {{ .Scratch.Set "noindex" true }}
    <h1>CategorÃ­a no disponible</h1>
    <p class="muted">Falta la categorÃ­a de recambio.</p>
    <a class="chip" href="{{ (printf "/modelos/%s/" $modelSlug) | relURL }}">Volver al modelo</a>
    {{ return }}
  {{ end }}

  {{/* Cat label (desde globals.categorias_recambios) */}}
  {{ $cats := $db.globals.categorias_recambios }}
  {{ $catLabel := $catKey }}
  {{ if and $cats (reflect.IsSlice $cats) }}
    {{ range $c := $cats }}
      {{ if eq ((index $c "key") | urlize) $catKey }}
        {{ $catLabel = index $c "label" }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ $rec := index $model "recambios" }}
  {{ if not (and $rec (reflect.IsMap $rec)) }}
    {{ .Scratch.Set "noindex" true }}
    <div class="card" style="margin-top:14px;">
      <h3>En preparaciÃ³n</h3>
      <p class="muted">AÃºn no tenemos recambios cargados para este modelo.</p>
      <a class="chip" href="{{ (printf "/modelos/%s/" $modelSlug) | relURL }}">Volver al modelo</a>
    </div>
    {{ return }}
  {{ end }}

  {{ $items := (index $rec $catKey) }}
  {{ if not (and $items (reflect.IsSlice $items) (gt (len $items) 0)) }}
    {{ .Scratch.Set "noindex" true }}
    <div class="card" style="margin-top:14px;">
      <h3>En preparaciÃ³n</h3>
      <p class="muted">AÃºn no tenemos recambios listados en esta categorÃ­a.</p>
      <a class="chip" href="{{ (printf "/modelos/%s/" $modelSlug) | relURL }}">Volver al modelo</a>
    </div>
    {{ return }}
  {{ end }}

  <div class="breadcrumbs">
    <a href="{{ "/" | relURL }}">Inicio</a><span class="sep">â€º</span>
    <a href="{{ "/marcas/" | relURL }}">Marcas</a><span class="sep">â€º</span>
    <a href="{{ (printf "/marcas/%s/" ($brandKey|urlize)) | relURL }}">{{ $brand.name }}</a><span class="sep">â€º</span>
    <a href="{{ (printf "/modelos/%s/" $modelSlug) | relURL }}">{{ $mtitle }}</a><span class="sep">â€º</span>
    <span>{{ $catLabel }}</span>
  </div>

  <div class="hero" style="margin-top:10px;">
    <div class="kicker">Recambios</div>
    <h1>{{ $catLabel }} compatibles para {{ $mtitle }}</h1>
    <p class="muted">
      SelecciÃ³n de {{ $catLabel | lower }} para {{ $mtitle }} con enlaces verificados.
      Antes de comprar, revisa compatibilidad (modelo/serie), medidas y conectores.
    </p>

    <div class="chips">
      <a class="chip" href="{{ (printf "/modelos/%s/" $modelSlug) | relURL }}">â† Volver al modelo</a>
      <a class="chip" href="{{ "/guias/compra/" | relURL }}">GuÃ­a: cÃ³mo elegir recambio</a>
      <a class="chip" href="{{ "/guias/seguridad/" | relURL }}">Seguridad</a>
    </div>
  </div>

  {{/* Crosslinks (wrap) */}}
  {{ partial "model_crosslinks.html" (dict
    "db" site.Data.aspiradores
    "brandKey" .Params.brandKey
    "modelSlug" .Params.modelSlug
    "currentCat" .Params.catKey
    "wrap" true
  ) }}

  <div class="two-col" style="margin-top:12px;">
    <div class="panel">
      <h2 style="margin-top:0;">CÃ³mo acertar al 100% (checklist)</h2>
      <ul class="list">
        <li><strong>Confirma el modelo exacto</strong>: serie, submodelo y referencias del fabricante.</li>
        <li><strong>Comprueba encaje y conectores</strong>: pestaÃ±as, pines, forma del conector y polaridad.</li>
        <li><strong>Revisa especificaciones</strong> (voltaje/capacidad/material) y fotos reales del anuncio.</li>
        <li><strong>Si dudas entre dos opciones</strong>, prioriza la que indique compatibilidad explÃ­cita con {{ $mtitle }}.</li>
      </ul>

      <hr>

      <h2>Recambios disponibles</h2>
      <div class="products">
        {{ range $it := $items }}
          <div class="product">
            <div class="img">{{ partial "cat_icon.html" (dict "catKey" $catKey) }}</div>
            <div class="body">
              <div class="title">{{ index $it "title" }}</div>
              {{ with (index $it "note") }}<div class="note muted" style="margin-top:10px;">{{ . }}</div>{{ end }}
              <div class="cta">
                {{ $sku := index $it "sku" }}
                {{ partial "offer_btn.html" (dict "sku" $sku "label" "Ver oferta" "class" "btn-buy") }}
              </div>
            </div>
          </div>
        {{ end }}
      </div>
    </div>

    <aside class="panel">
      <h2 style="margin-top:0;">Â¿QuÃ© recambio necesito?</h2>
      <p class="muted">
        Si tu problema es â€œno funciona / no carga / pierde potenciaâ€, puede que el recambio correcto no sea este.
        Mira las guÃ­as de diagnÃ³stico y los recambios relacionados.
      </p>

      {{/* Problemas relacionados: lee model.problemas y muestra 3-6 */}}
      {{ $plist := index $model "problemas" }}
      {{ if and $plist (reflect.IsSlice $plist) (gt (len $plist) 0) }}
        <h3 style="margin-top:14px;">Problemas frecuentes</h3>
        <div class="chips" style="margin-top:8px;">
          {{ $shown := 0 }}
          {{ range $p := $plist }}
            {{ if lt $shown 6 }}
              {{ $pk := (index $p "key") | default "" | urlize }}
              {{ $pt := (index $p "title") | default "Ver guÃ­a" }}
              {{ if $pk }}
                <a class="chip" href="{{ (printf "/modelos/%s/problemas/%s/" $modelSlug $pk) | relURL }}">{{ $pt }}</a>
                {{ $shown = add $shown 1 }}
              {{ end }}
            {{ end }}
          {{ end }}
        </div>
        <hr>
      {{ end }}

      <h3 style="margin-top:0;">GuÃ­as Ãºtiles</h3>
      <div class="chips" style="margin-top:8px;">
        <a class="chip" href="{{ "/guias/compra/" | relURL }}">CÃ³mo elegir</a>
        <a class="chip" href="{{ "/guias/mantenimiento/" | relURL }}">Mantenimiento</a>
        <a class="chip" href="{{ "/guias/seguridad/" | relURL }}">Seguridad</a>
      </div>

      <p class="muted small" style="margin-top:12px;">
        Algunos enlaces pueden ser de afiliaciÃ³n. Precio y disponibilidad dependen del vendedor.
      </p>
    </aside>
  </div>
{{ end }}
