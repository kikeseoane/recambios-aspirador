{{/* layouts/modelos/problema.html */}}
{{ define "main" }}
  {{ $db := site.Data.aspiradores }}
  {{ $brands := $db.brands }}

  {{ $brandKey := .Params.brandKey | default "" }}
  {{ $modelSlug := (or .Params.modelSlug .Params.slug) | default "" | urlize }}
  {{ $problemKey := .Params.problemKey | default "" | urlize }}

  {{ if or (not $brandKey) (not $modelSlug) (not $problemKey) }}
    {{ .Scratch.Set "noindex" true }}
    <h1>Problema no disponible</h1>
    <p class="muted">Faltan parámetros para mostrar esta página.</p>
    <div class="chips" style="margin-top:12px;">
      <a class="chip" href="{{ "/modelos/" | relURL }}">Ver modelos</a>
      <a class="chip" href="{{ "/marcas/" | relURL }}">Ver marcas</a>
    </div>
    {{ return }}
  {{ end }}

  {{/* Marca */}}
  {{ $brand := dict }}
  {{ if and $brands (isset $brands $brandKey) }}
    {{ $brand = index $brands $brandKey }}
  {{ end }}

  {{ if not $brand }}
    {{ .Scratch.Set "noindex" true }}
    <h1>Problema no disponible</h1>
    <p class="muted">No encontramos la marca asociada.</p>
    <a class="chip" href="{{ "/modelos/" | relURL }}">Ver modelos</a>
    {{ return }}
  {{ end }}

  {{/* Modelo */}}
  {{ $model := dict }}
  {{ range $m := ($brand.models | default (slice)) }}
    {{ $mid := (or (index $m "slug") (index $m "canonical_slug") (index $m "id")) | default "" | urlize }}
    {{ if eq $mid $modelSlug }}
      {{ $model = $m }}
    {{ end }}
  {{ end }}

  {{ if not (len $model) }}
    {{ .Scratch.Set "noindex" true }}
    <h1>Problema en preparación</h1>
    <p class="muted">No encontramos el modelo en el catálogo.</p>
    <div class="chips" style="margin-top:12px;">
      <a class="chip" href="{{ (printf "/marcas/%s/" ($brandKey|urlize)) | relURL }}">Volver a {{ $brand.name }}</a>
      <a class="chip" href="{{ "/modelos/" | relURL }}">Ver modelos</a>
    </div>
    {{ return }}
  {{ end }}

  {{ $mtitle := partial "model_title.html" (dict "brandName" $brand.name "modelName" (index $model "model")) }}
  {{ if not $mtitle }}{{ $mtitle = $modelSlug }}{{ end }}

  {{/* Problema (desde YAML) */}}
  {{ $p := dict }}
  {{ $plist := index $model "problemas" }}
  {{ if and $plist (reflect.IsSlice $plist) }}
    {{ range $it := $plist }}
      {{ $k := (index $it "key") | default "" | urlize }}
      {{ if eq $k $problemKey }}
        {{ $p = $it }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ if not (len $p) }}
    {{ .Scratch.Set "noindex" true }}
    <h1>Problema en preparación</h1>
    <p class="muted">Aún no tenemos esta guía de diagnóstico.</p>
    <div class="chips" style="margin-top:12px;">
      <a class="chip" href="{{ (printf "/modelos/%s/" $modelSlug) | relURL }}">← Volver al modelo</a>
      <a class="chip" href="{{ (printf "/modelos/%s/problemas/" $modelSlug) | relURL }}">Ver problemas del modelo</a>
      <a class="chip" href="{{ (printf "/marcas/%s/" ($brandKey|urlize)) | relURL }}">Más modelos {{ $brand.name }}</a>
    </div>
    {{ return }}
  {{ end }}

  {{ $ptitle := (index $p "title") | default .Title }}

  <div class="breadcrumbs">
    <a href="{{ "/" | relURL }}">Inicio</a><span class="sep">›</span>
    <a href="{{ "/marcas/" | relURL }}">Marcas</a><span class="sep">›</span>
    <a href="{{ (printf "/marcas/%s/" ($brandKey|urlize)) | relURL }}">{{ $brand.name }}</a><span class="sep">›</span>
    <a href="{{ (printf "/modelos/%s/" $modelSlug) | relURL }}">{{ $mtitle }}</a><span class="sep">›</span>
    <a href="{{ (printf "/modelos/%s/problemas/" $modelSlug) | relURL }}">Problemas</a><span class="sep">›</span>
    <span>{{ $ptitle }}</span>
  </div>

  <div class="hero" style="margin-top:10px;">
    <div class="kicker">Problema</div>
    <h1>{{ $ptitle }}</h1>
    {{ with (index $p "intro") }}<p class="muted">{{ . }}</p>{{ end }}

    <div class="chips">
      <a class="chip" href="{{ (printf "/modelos/%s/" $modelSlug) | relURL }}">← Volver al modelo</a>
      <a class="chip" href="{{ (printf "/modelos/%s/problemas/" $modelSlug) | relURL }}">Ver todos los problemas</a>
      <a class="chip" href="{{ "/guias/seguridad/" | relURL }}">Seguridad</a>
      <a class="chip" href="{{ "/guias/mantenimiento/" | relURL }}">Mantenimiento</a>
    </div>
  </div>

  <div class="two-col" style="margin-top:12px;">
    <div class="panel">
      <h2 style="margin-top:0;">Diagnóstico rápido</h2>
      <ol class="list">
        <li><strong>Revisa lo básico</strong>: encajes, depósito, filtros y obstrucciones visibles.</li>
        <li><strong>Una variable cada vez</strong>: prueba cambios de uno en uno para aislar la causa.</li>
        <li><strong>Confirma compatibilidad</strong> antes de comprar: modelo/serie, conectores, medidas y fotos reales.</li>
      </ol>

      {{ $sym := index $p "symptoms" }}
      {{ if and $sym (reflect.IsSlice $sym) (gt (len $sym) 0) }}
        <hr>
        <h2>Síntomas habituales</h2>
        <ul class="list">
          {{ range $sym }}<li>{{ . }}</li>{{ end }}
        </ul>
      {{ end }}

      {{ $checks := index $p "checks" }}
      {{ if and $checks (reflect.IsSlice $checks) (gt (len $checks) 0) }}
        <hr>
        <h2>Comprobaciones rápidas</h2>
        <ul class="list">
          {{ range $checks }}<li>{{ . }}</li>{{ end }}
        </ul>
        {{ with (index $p "fix_hint") }}<p class="muted small" style="margin-top:10px;">{{ . }}</p>{{ end }}
      {{ end }}

      {{ $causes := index $p "causes" }}
      {{ if and $causes (reflect.IsSlice $causes) (gt (len $causes) 0) }}
        <hr>
        <h2>Causas probables</h2>
        <ul class="list">
          {{ range $causes }}<li>{{ . }}</li>{{ end }}
        </ul>
      {{ end }}

      {{/* FAQ visible opcional (si lo metes en YAML) */}}
      {{ $faqs := index $p "faqs" }}
      {{ if and $faqs (reflect.IsSlice $faqs) (gt (len $faqs) 0) }}
        <hr>
        <h2>Preguntas frecuentes</h2>
        <div class="faq">
          {{ range $fa := $faqs }}
            <details class="card" style="margin-top:10px;">
              <summary><strong>{{ index $fa "q" }}</strong></summary>
              <div class="muted" style="margin-top:8px;">{{ index $fa "a" }}</div>
            </details>
          {{ end }}
        </div>
      {{ end }}
    </div>

    <aside class="panel">
      <h2 style="margin-top:0;">Recambio recomendado</h2>

      {{ $cta := index $p "cta" }}
      {{ $catKey := "" }}
      {{ $label := "Ver recambios compatibles" }}

      {{ if and $cta (reflect.IsMap $cta) }}
        {{ $catKey = (index $cta "catKey") | default "" | urlize }}
        {{ $label = (index $cta "label") | default $label }}
      {{ end }}

      {{ if $catKey }}
        <a class="btn-buy" href="{{ (printf "/modelos/%s/%s/" $modelSlug $catKey) | relURL }}">{{ $label }}</a>
        <p class="muted small" style="margin-top:10px;">Verifica encaje, conector y especificaciones antes de comprar.</p>

        {{/* 3 opciones (si existen) */}}
        {{ $rec := index $model "recambios" }}
        {{ if and $rec (reflect.IsMap $rec) }}
          {{ $items := index $rec $catKey }}
          {{ if and $items (reflect.IsSlice $items) (gt (len $items) 0) }}
            <hr>
            <h3 style="margin-top:0;">Opciones populares</h3>
            <div class="products" style="margin-top:10px;">
              {{ $shown := 0 }}
              {{ range $it := $items }}
                {{ if lt $shown 3 }}
                  <div class="product">
                    <div class="img">{{ partial "cat_icon.html" (dict "catKey" $catKey) }}</div>
                    <div class="body">
                      <div class="title">{{ index $it "title" }}</div>
                      {{ with (index $it "note") }}<div class="note muted" style="margin-top:10px;">{{ . }}</div>{{ end }}
                      <div class="cta" style="margin-top:10px;">
                        {{ $sku := index $it "sku" }}
                        {{ partial "offer_btn.html" (dict "sku" $sku "label" "Ver oferta" "class" "btn-buy") }}
                      </div>
                    </div>
                  </div>
                  {{ $shown = add $shown 1 }}
                {{ end }}
              {{ end }}
            </div>
          {{ end }}
        {{ end }}

      {{ else }}
        <p class="muted">Estamos preparando la recomendación de recambio para este problema.</p>
      {{ end }}

      <hr>

      {{/* Crosslinks: sin wrap */}}
      {{ partial "model_crosslinks.html" (dict
        "db" site.Data.aspiradores
        "brandKey" .Params.brandKey
        "modelSlug" .Params.modelSlug
        "currentProblem" .Params.problemKey
        "wrap" false
      ) }}

      <p class="muted small" style="margin-top:12px;">
        Algunos enlaces pueden ser de afiliación. Precio y disponibilidad dependen del vendedor.
      </p>
    </aside>
  </div>
{{ end }}
