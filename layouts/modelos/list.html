{{/* layouts/modelos/list.html */}}

{{ define "main" }}
  {{ $db := site.Data.aspiradores }}
  {{ $brands := $db.brands }}

  {{/* =========================================================
       CASO 1: RAÍZ /modelos/  -> content/modelos/_index.md
       No tiene .Params.brandKey, así que NO podemos indexar brand
     ========================================================= */}}

  {{ $brandKey := .Params.brandKey }}

  {{ if not $brandKey }}

    <div class="hero" style="margin-top:10px;">
      <div class="kicker">Modelos</div>
      <h1>{{ .Title }}</h1>
      <p class="muted">Explora por marca y entra en la ficha del modelo para ver recambios y problemas.</p>

      <div class="chips">
        <a class="chip" href="{{ "/marcas/" | relURL }}">Ver marcas</a>
        <a class="chip" href="{{ "/guias/compra/" | relURL }}">Cómo elegir recambio</a>
        <a class="chip" href="{{ "/guias/mantenimiento/" | relURL }}">Mantenimiento</a>
        <a class="chip" href="{{ "/guias/seguridad/" | relURL }}">Seguridad</a>
      </div>
    </div>

    {{ if not $brands }}
      <div class="card">
        <h2 style="margin-top:0;">Sin datos</h2>
        <p class="muted">No se ha cargado <code>data/aspiradores.yaml</code> o no contiene <code>brands</code>.</p>
      </div>
    {{ else }}

      {{/* Listado por marcas con algunos modelos visibles */}}
      <div class="grid cards" style="margin-top:14px;">
        {{ range $k, $b := $brands }}
          {{ $brandSlug := ($k | urlize) }}
          <div class="card">
            <div class="breadcrumbs" style="margin:0 0 10px 0;">
              <a href="{{ "/" | relURL }}">Inicio</a><span class="sep">›</span>
              <a href="{{ "/marcas/" | relURL }}">Marcas</a><span class="sep">›</span>
              <a href="{{ (printf "/marcas/%s/" $brandSlug) | relURL }}">{{ $b.name }}</a>
            </div>

            <h2 style="margin:0 0 8px 0;">{{ $b.name }}</h2>

            {{ $models := $b.models }}
            {{ if and $models (reflect.IsSlice $models) (gt (len $models) 0) }}
              <p class="muted small" style="margin:0 0 10px 0;">{{ len $models }} modelos</p>

              <div class="chips" style="flex-wrap:wrap;">
                {{ range $i, $m := $models }}
                  {{/* muestra máximo 10 chips por marca para no petar el layout */}}
                  {{ if lt $i 10 }}
                    {{ $mid := (or (index $m "slug") (index $m "canonical_slug") (index $m "id")) | urlize }}
                    {{ $mname := (index $m "model") | default $mid }}
                    {{ if $mid }}
                      <a class="chip" href="{{ (printf "/modelos/%s/" $mid) | relURL }}">{{ $mname }}</a>
                    {{ end }}
                  {{ end }}
                {{ end }}
                <a class="chip active" href="{{ (printf "/marcas/%s/" $brandSlug) | relURL }}">Ver todos los modelos</a>
              </div>
            {{ else }}
              <p class="muted">Aún no hay modelos cargados para esta marca.</p>
              <div class="chips">
                <a class="chip" href="{{ (printf "/marcas/%s/" $brandSlug) | relURL }}">Ir a la marca</a>
              </div>
            {{ end }}
          </div>
        {{ end }}
      </div>

    {{ end }}

  {{ else }}

  {{/* =========================================================
       CASO 2: /modelos/<slug>/  -> content/modelos/<slug>/_index.md
       Modelo = sección (branch bundle). Aquí SÍ hay brandKey.
     ========================================================= */}}

    {{ $modelSlug := (or .Params.modelSlug .Params.slug) | urlize }}

    {{ $brand := nil }}
    {{ if and $brands $brandKey }}
      {{ $brand = index $brands $brandKey }}
    {{ end }}

    {{ if not $brand }}
      {{/* inválida -> noindex */}}
      {{ .Scratch.Set "noindex" true }}

      <h1>Modelo no disponible</h1>
      <p class="muted">No encontramos la marca asociada a este modelo.</p>
      <div class="chips" style="margin-top:14px;">
        <a class="chip" href="{{ "/marcas/" | relURL }}">Ver marcas</a>
        <a class="chip" href="{{ "/modelos/" | relURL }}">Ver todos los modelos</a>
      </div>

    {{ else }}

      {{/* Buscar modelo en YAML */}}
      {{ $model := dict }}
      {{ $models := $brand.models }}

      {{ if and $models (reflect.IsSlice $models) }}
        {{ range $m := $models }}
          {{ $mid := (or (index $m "slug") (index $m "canonical_slug") (index $m "id")) | urlize }}
          {{ if eq $mid $modelSlug }}
            {{ $model = $m }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ if not (len $model) }}
        {{ .Scratch.Set "noindex" true }}

        <div class="breadcrumbs">
          <a href="{{ "/" | relURL }}">Inicio</a><span class="sep">›</span>
          <a href="{{ "/marcas/" | relURL }}">Marcas</a><span class="sep">›</span>
          <a href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">{{ $brand.name }}</a>
        </div>

        {{ $title := partial "model_title.html" (dict "brandName" $brand.name "modelName" $modelSlug) }}
        <h1>{{ $title }}</h1>

        <p class="muted">Estamos terminando de preparar la ficha de este modelo.</p>

        <div class="card" style="margin-top:14px;">
          <h3>Mientras tanto</h3>
          <p class="muted">Puedes volver a la marca y elegir otro modelo disponible.</p>
          <div class="chips" style="margin-top:10px;">
            <a class="chip" href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">Ver modelos {{ $brand.name }}</a>
            <a class="chip" href="{{ "/modelos/" | relURL }}">Todos los modelos</a>
          </div>
        </div>

      {{ else }}

        {{/* ===== THIN CONTENT CHECK (modelo vacío real) ===== */}}

        {{ $hasRecambios := false }}
        {{ $rec := index $model "recambios" }}
        {{ if and $rec (reflect.IsMap $rec) }}
          {{ range $k, $v := $rec }}
            {{ if and $v (reflect.IsSlice $v) (gt (len $v) 0) }}
              {{ $hasRecambios = true }}
            {{ end }}
          {{ end }}
        {{ end }}

        {{ $probs := index $model "problemas" }}
        {{ $hasProblemas := and $probs (reflect.IsSlice $probs) (gt (len $probs) 0) }}

        {{ $fallos := index $model "fallos" }}
        {{ $hasFallos := and $fallos (reflect.IsSlice $fallos) (gt (len $fallos) 0) }}

        {{ $guias := index $model "guias" }}
        {{ $hasGuias := and $guias (reflect.IsSlice $guias) (gt (len $guias) 0) }}

        {{ $introLen := 0 }}
        {{ with (index $model "intro") }}
          {{ $introLen = len (plainify .) }}
        {{ end }}

        {{ $isThin := and (not $hasRecambios) (not $hasProblemas) (not $hasFallos) (not $hasGuias) (lt $introLen 80) }}
        {{ if $isThin }}
          {{ .Scratch.Set "noindex" true }}
        {{ end }}

        {{/* ===== TÍTULO DEL MODELO (scope seguro) ===== */}}
        {{ $mtitle := partial "model_title.html" (dict "brandName" $brand.name "modelName" (index $model "model")) }}
        {{ if not $mtitle }}
          {{ $mtitle = .Title }}
        {{ end }}

        <div class="breadcrumbs">
          <a href="{{ "/" | relURL }}">Inicio</a><span class="sep">›</span>
          <a href="{{ "/marcas/" | relURL }}">Marcas</a><span class="sep">›</span>
          <a href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">{{ $brand.name }}</a><span class="sep">›</span>
          <span>{{ $mtitle }}</span>
        </div>

        <div class="hero" style="margin-top:10px;">
          <div class="kicker">Modelo</div>
          <h1>{{ $mtitle }}</h1>
          {{ with (index $model "intro") }}<p class="muted">{{ . }}</p>{{ end }}

          <div class="chips">
            {{ with (index $model "series") }}<span class="chip active">Serie {{ . }}</span>{{ end }}
            {{ with (index $model "year_range") }}<span class="chip">{{ . }}</span>{{ end }}
            <a class="chip" href="{{ "/guias/compra/" | relURL }}">Cómo elegir recambio</a>
            <a class="chip" href="{{ "/guias/mantenimiento/" | relURL }}">Mantenimiento</a>
            <a class="chip" href="{{ "/guias/seguridad/" | relURL }}">Seguridad</a>
          </div>
        </div>

        <div class="two-col" style="margin-top:12px;">
          <div class="panel">
            <h2 style="margin-top:0;">Compatibilidad rápida</h2>

            {{ $compat := index $model "compatibilidad" }}
            {{ if $compat }}
              {{ if reflect.IsSlice $compat }}
                <ul class="list">
                  {{ range $compat }}<li>{{ . }}</li>{{ end }}
                </ul>
              {{ else }}
                <p class="muted">{{ $compat }}</p>
              {{ end }}
            {{ else }}
              <p class="muted">Consejo: confirma variante exacta (Animal/Absolute/etc.) y compara encajes en el anuncio.</p>
            {{ end }}

            <hr>

            <h2 style="margin-top:0;">Recambios compatibles</h2>
            <p class="muted small">Verifica compatibilidad exacta (conectores, encaje y voltaje) antes de comprar.</p>

            {{ $cats := $db.globals.categorias_recambios }}
            {{ $rec := index $model "recambios" }}

            {{ if and $cats (reflect.IsSlice $cats) (and $rec (reflect.IsMap $rec)) }}
              {{ range $cat := $cats }}
                {{ $catKey := index $cat "key" }}
                {{ $catLabel := index $cat "label" }}

                {{ $items := index $rec $catKey }}
                {{ if $items }}
                  <div class="section-head" style="margin-top:18px;">
                    <h2 style="margin:0;">{{ $catLabel }}</h2>
                    <a class="chip" href="{{ (printf "/modelos/%s/%s/" $modelSlug ($catKey|urlize)) | relURL }}">Ver todo</a>
                  </div>

                  <div class="products">
                    {{ if reflect.IsSlice $items }}
                      {{ range $it := $items }}
                        <div class="product">
                          <div class="img">{{ partial "cat_icon.html" (dict "catKey" ($catKey|urlize)) }}</div>
                          <div class="body">
                            <div class="title">{{ index $it "title" }}</div>

                            {{ with (index $it "note") }}
                              <div class="note muted" style="margin-top:10px;">{{ . }}</div>
                            {{ end }}

                            <div class="cta">
                              {{ $sku := index $it "sku" }}
                              {{ partial "offer_btn.html" (dict "sku" $sku "label" "Ver oferta" "class" "btn-buy") }}
                            </div>
                          </div>
                        </div>
                      {{ end }}
                    {{ else }}
                      <div class="card">
                        <p class="muted">Formato de recambios incorrecto (se esperaba una lista).</p>
                      </div>
                    {{ end }}
                  </div>
                {{ end }}
              {{ end }}
            {{ else }}
              <p class="muted">Aún no hay recambios cargados para este modelo.</p>
            {{ end }}

            <hr>

            {{/* ===== Problemas frecuentes ===== */}}
            {{ $probs := index $model "problemas" }}
            {{ if and $probs (reflect.IsSlice $probs) (gt (len $probs) 0) }}
              <h2 style="margin-top:0;">Problemas frecuentes</h2>
              <p class="muted small">Diagnósticos rápidos con checks y recambios recomendados.</p>

              <div class="grid cards">
                {{ range $p := $probs }}
                  {{ $pkey := (index $p "key") | urlize }}
                  {{ $ptitle := (index $p "title") | default $pkey }}
                  <a class="card" href="{{ (printf "/modelos/%s/problemas/%s/" $modelSlug $pkey) | relURL }}">
                    <h3>{{ $ptitle }}</h3>
                    {{ with (index $p "intent") }}<span class="badge blue">{{ . }}</span>{{ end }}
                    {{ with (index $p "symptoms") }}
                      {{ if reflect.IsSlice . }}
                        <p class="muted" style="margin-top:8px;">Síntomas: {{ index . 0 }}</p>
                      {{ end }}
                    {{ end }}
                  </a>
                {{ end }}
              </div>

              <hr>
            {{ end }}

            <h2 style="margin-top:0;">Fallos comunes y checks</h2>

            {{ $fallos := index $model "fallos" }}
            {{ if $fallos }}
              {{ if reflect.IsSlice $fallos }}
                <div class="grid cols-2">
                  {{ range $f := $fallos }}
                    <div class="panel">
                      <div class="badge warn">Síntoma</div>
                      <h3 style="margin:10px 0 8px;">{{ index $f "symptom" }}</h3>

                      {{ $causas := index $f "causas" }}
                      {{ if $causas }}
                        <div class="kicker">Causas probables</div>
                        {{ if reflect.IsSlice $causas }}
                          <ul>
                            {{ range $causas }}<li>{{ . }}</li>{{ end }}
                          </ul>
                        {{ else }}
                          <p class="muted">{{ $causas }}</p>
                        {{ end }}
                      {{ end }}

                      {{ $checks := index $f "checks" }}
                      {{ if $checks }}
                        <div class="kicker">Cómo comprobar</div>
                        {{ if reflect.IsSlice $checks }}
                          <ul>
                            {{ range $checks }}<li>{{ . }}</li>{{ end }}
                          </ul>
                        {{ else }}
                          <p class="muted">{{ $checks }}</p>
                        {{ end }}
                      {{ end }}

                      {{ with (index $f "fix_hint") }}
                        <p class="muted small" style="margin-top:10px;">{{ . }}</p>
                      {{ end }}
                    </div>
                  {{ end }}
                </div>
              {{ else }}
                <p class="muted">{{ $fallos }}</p>
              {{ end }}
            {{ else }}
              <p class="muted">Iremos añadiendo los fallos más típicos y comprobaciones rápidas.</p>
            {{ end }}
          </div>

          <aside class="panel">
            <h2 style="margin-top:0;">Antes de comprar</h2>
            <p class="muted small">Checklist rápida para evitar incompatibilidades.</p>

            {{ $compra := partial "get_guia.html" (dict "db" $db "key" "compra") }}

            <div class="panel" style="box-shadow:none;background:#fff;border-style:dashed;">
              {{ if $compra }}
                {{ if reflect.IsSlice $compra }}
                  <div class="kicker">Cómo elegir recambio compatible</div>
                  <ul class="small">
                    {{ range $compra }}<li>{{ . }}</li>{{ end }}
                  </ul>
                {{ else if reflect.IsMap $compra }}
                  {{ with (index $compra "title") }}<div class="kicker">{{ . }}</div>{{ end }}

                  {{ $bullets := index $compra "bullets" }}
                  {{ if $bullets }}
                    {{ if reflect.IsSlice $bullets }}
                      <ul class="small">
                        {{ range $bullets }}<li>{{ . }}</li>{{ end }}
                      </ul>
                    {{ else }}
                      <p class="muted small">{{ $bullets }}</p>
                    {{ end }}
                  {{ else }}
                    <p class="muted small">Revisa modelo exacto, encajes y política de devolución.</p>
                  {{ end }}
                {{ else }}
                  <div class="kicker">Cómo elegir recambio compatible</div>
                  <p class="muted small">Revisa modelo exacto, encajes y política de devolución.</p>
                {{ end }}
              {{ else }}
                <div class="kicker">Cómo elegir recambio compatible</div>
                <p class="muted small">Revisa modelo exacto, encajes y política de devolución.</p>
              {{ end }}
            </div>

            <div style="margin-top:12px;">
              <div class="kicker">Atajos</div>
              <div class="chips">
                <a class="chip" href="{{ "/marcas/" | relURL }}">Más marcas</a>
                <a class="chip" href="{{ (printf "/marcas/%s/" ($brandKey | urlize)) | relURL }}">Más modelos {{ $brand.name }}</a>
                <a class="chip" href="{{ "/modelos/" | relURL }}">Todos los modelos</a>
              </div>
            </div>

            <hr>

            <div class="kicker">Transparencia</div>
            <p class="muted small">Algunos enlaces pueden ser de afiliación. Precio y disponibilidad dependen del vendedor.</p>
          </aside>
        </div>

      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}
