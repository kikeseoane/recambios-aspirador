{{/* layouts/modelos/problemas.html */}}

{{ define "main" }}
  {{ $db := site.Data.aspiradores }}
  {{ $brands := $db.brands }}

  {{ $brandKey := .Params.brandKey }}
  {{ $modelSlug := (or .Params.modelSlug .Params.slug) | urlize }}

  {{ $brand := cond (and $brands $brandKey) (index $brands $brandKey) nil }}
  {{ $model := "" }}

  {{ if and $brand (isset $brand "models") }}
    {{/* En tu YAML, brand.models es LISTA, no dict -> buscamos por slug */}}
    {{ range $m := $brand.models }}
      {{ $ms := (or (index $m "slug") (printf "%s-%s" $brandKey (index $m "model"))) | urlize }}
      {{ if eq $ms $modelSlug }}
        {{ $model = $m }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ if not $brand }}
    {{ .Scratch.Set "noindex" true }}
    <h1>Modelo no encontrado</h1>
    <p>No se ha podido resolver la marca del modelo.</p>
    {{ return }}
  {{ end }}

  {{ if not $model }}
    {{ .Scratch.Set "noindex" true }}
    <h1>Modelo no encontrado</h1>
    <p>No se ha encontrado el modelo en la base de datos.</p>
    {{ return }}
  {{ end }}

  {{ $problemas := (or (index $model "problemas") (slice)) }}
  {{ if or (not (reflect.IsSlice $problemas)) (eq (len $problemas) 0) }}
    {{ .Scratch.Set "noindex" true }}
  {{ end }}

  {{ $modelName := (or (index $model "model") .Title) }}
  {{ $modelURL := (printf "/modelos/%s/" $modelSlug) | relURL }}

  <nav aria-label="Breadcrumb" class="breadcrumbs">
    <a href="{{ "/" | relURL }}">Inicio</a>
    <span>›</span>
    <a href="{{ "/modelos/" | relURL }}">Modelos</a>
    <span>›</span>
    <a href="{{ $modelURL }}">{{ $modelName }}</a>
    <span>›</span>
    <span>Problemas</span>
  </nav>

  <header class="page-header">
    <h1>Problemas frecuentes de {{ $modelName }}</h1>

    {{ if eq (len $problemas) 0 }}
      <p>No hay problemas definidos para este modelo.</p>
    {{ else }}
      <p>Selecciona el síntoma para ver causas probables y recambios recomendados.</p>
    {{ end }}
  </header>

  {{/* Acceso rápido a recambios del modelo */}}
  {{ $rec := (or (index $model "recambios") (dict)) }}
  {{ if and (reflect.IsMap $rec) (gt (len $rec) 0) }}
    <section class="quick-links">
      <h2>Recambios del modelo</h2>
      <ul>
        {{ range $catKey, $items := $rec }}
          {{ if gt (len $items) 0 }}
            <li>
              <a href="{{ (printf "/modelos/%s/%s/" $modelSlug ($catKey | urlize)) | relURL }}">
                {{ humanize $catKey }}
              </a>
            </li>
          {{ end }}
        {{ end }}
      </ul>
    </section>
  {{ end }}

  {{ if gt (len $problemas) 0 }}
    <section class="grid">
      {{ range $p := $problemas }}
        {{ if not (reflect.IsMap $p) }}{{ continue }}{{ end }}

        {{ $pkey := (or (index $p "key") "") | urlize }}
        {{ $ptitle := (or (index $p "title") (humanize $pkey)) }}

        {{ if not $pkey }}{{ continue }}{{ end }}

        <article class="card">
          <h2>
            <a href="{{ (printf "/modelos/%s/problemas/%s/" $modelSlug $pkey) | relURL }}">
              {{ $ptitle }}
            </a>
          </h2>

          {{ with (index $p "intent") }}
            <p class="muted">{{ . }}</p>
          {{ end }}

          {{ $s := (index $p "sintomas") }}
          {{ if and $s (reflect.IsSlice $s) (gt (len $s) 0) }}
            <ul class="bullets">
              {{ range first 3 $s }}
                <li>{{ . }}</li>
              {{ end }}
            </ul>
          {{ end }}

          <p><a class="btn" href="{{ (printf "/modelos/%s/problemas/%s/" $modelSlug $pkey) | relURL }}">Ver solución</a></p>
        </article>
      {{ end }}
    </section>

    <p class="backlink">
      <a href="{{ $modelURL }}">← Volver a {{ $modelName }}</a>
    </p>
  {{ end }}
{{ end }}
