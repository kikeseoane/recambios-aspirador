{{/* layouts/modelos/recambio.html */}}
{{ define "main" }}

  {{/* =========================
      1) Resolver brand/model/cat
     ========================= */}}
  {{ $db := site.Data.aspiradores }}
  {{ $brands := $db.brands }}

  {{ $brandKey := or .Params.brandKey (and .Parent .Parent.Params.brandKey) (and .Parent .Params.brandKey) }}
  {{ $modelSlug := or .Params.modelSlug .Params.slug (and .Parent .Parent.Params.modelSlug) (and .Parent .Params.modelSlug) }}
  {{ $catKey := or .Params.catKey .Params.recambioKey .Params.categoryKey }}

  {{ $brand := cond (and $brands $brandKey) (index $brands $brandKey) nil }}
  {{ $model := cond (and $brand $modelSlug (isset $brand.models $modelSlug)) (index $brand.models $modelSlug) nil }}

  {{/* nombre “humano” del modelo: preferimos title del modelo; si no, el de la página padre */}}
  {{ $modelName := "" }}
  {{ if and $model (isset $model "title") }}{{ $modelName = $model.title }}{{ end }}
  {{ if and (not $modelName) .Parent }}{{ $modelName = .Parent.Title }}{{ end }}
  {{ if not $modelName }}{{ $modelName = .Title }}{{ end }}

  {{/* items de recambio para esta categoría */}}
  {{ $items := slice }}
  {{ if and $model $catKey (isset $model "recambios") (isset $model.recambios $catKey) }}
    {{ $items = index $model.recambios $catKey }}
  {{ end }}

  {{ $hasItems := gt (len $items) 0 }}

  {{/* =========================
      2) noindex si no hay data
     ========================= */}}
  {{ if or (not $brand) (not $model) (not $catKey) (not $hasItems) }}
    {{ .Scratch.Set "noindex" true }}
  {{ end }}

  {{/* =========================
      3) Breadcrumbs
     ========================= */}}
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <ol>
      <li><a href="{{ "/" | relURL }}">Inicio</a></li>
      <li><a href="{{ "/modelos/" | relURL }}">Modelos</a></li>
      {{ if $modelSlug }}
        <li><a href="{{ (printf "/modelos/%s/" $modelSlug) | relURL }}">{{ $modelName }}</a></li>
      {{ else if .Parent }}
        <li><a href="{{ .Parent.RelPermalink }}">{{ .Parent.Title }}</a></li>
      {{ end }}
      <li aria-current="page">{{ .Title }}</li>
    </ol>
  </nav>

  {{/* =========================
      4) Header + contenido principal
     ========================= */}}
  <header class="page-header">
    <h1>{{ .Title }}</h1>

    {{ if and $brand $model $catKey $hasItems }}
      {{ with .Params.intro }}
        <p class="lead">{{ . }}</p>
      {{ else }}
        <p class="lead">
          Recambios compatibles para <strong>{{ $modelName }}</strong>. Revisa la compatibilidad antes de comprar.
        </p>
      {{ end }}
    {{ else }}
      <p class="lead">
        No hay información suficiente para esta página (modelo o categoría sin datos).
      </p>
    {{ end }}
  </header>

  {{ if and $brand $model $catKey $hasItems }}

    {{/* =========================
        5) Lista de recambios (ItemList)
       ========================= */}}
    <section class="cards">
      <h2>Opciones compatibles</h2>

      <ul class="product-list">
        {{ range $i, $it := $items }}
          {{ $sku := "" }}
          {{ if isset $it "sku" }}{{ $sku = $it.sku }}{{ end }}
          {{ $title := "" }}
          {{ if isset $it "title" }}{{ $title = $it.title }}{{ end }}
          {{ if not $title }}{{ $title = (printf "%s (%s)" $.Title $sku) }}{{ end }}

          <li class="product-card">
            <h3>{{ $title }}</h3>

            {{ if $sku }}
              <div class="muted">SKU: <code>{{ $sku }}</code></div>
            {{ end }}

            {{ with $it.notes }}
              <p>{{ . }}</p>
            {{ end }}

            {{/* botón afiliado: usa tu partial si existe */}}
            {{ partial "offer_btn.html" (dict "sku" $sku "ctx" $ "label" "Ver oferta") }}
          </li>
        {{ end }}
      </ul>
    </section>

    {{/* =========================
        6) Links internos: otras categorías del modelo
       ========================= */}}
    {{ $cats := slice }}
    {{ if and (isset $model "recambios") }}
      {{ range $k, $v := $model.recambios }}
        {{ if gt (len $v) 0 }}
          {{ $cats = $cats | append $k }}
        {{ end }}
      {{ end }}
    {{ end }}

    {{ if gt (len $cats) 1 }}
      <section class="internal-links">
        <h2>Más recambios para {{ $modelName }}</h2>
        <ul class="link-list">
          {{ range $k := $cats }}
            {{ if ne $k $catKey }}
              <li>
                <a href="{{ (printf "/modelos/%s/%s/" $modelSlug $k) | relURL }}">
                  {{ $k | humanize }}
                </a>
              </li>
            {{ end }}
          {{ end }}
        </ul>
      </section>
    {{ end }}

    {{/* =========================
        7) Links internos: problemas del modelo (top 5)
       ========================= */}}
    {{ $problemKeys := slice }}
    {{ if and (isset $model "problemas") }}
      {{ range $pk, $pv := $model.problemas }}
        {{ $problemKeys = $problemKeys | append $pk }}
      {{ end }}
    {{ end }}

    {{ if gt (len $problemKeys) 0 }}
      <section class="internal-links">
        <h2>Problemas comunes relacionados</h2>
        <ul class="link-list">
          {{ range first 5 $problemKeys }}
            <li>
              <a href="{{ (printf "/modelos/%s/problemas/%s/" $modelSlug .) | relURL }}">
                {{ . | humanize }}
              </a>
            </li>
          {{ end }}
        </ul>
      </section>
    {{ end }}

    <section class="internal-links">
      <h2>Siguiente paso</h2>
      <ul class="link-list">
        <li><a href="{{ (printf "/modelos/%s/" $modelSlug) | relURL }}">Volver al modelo: {{ $modelName }}</a></li>
        <li><a href="{{ "/guias/compra/" | relURL }}">Guía de compra</a></li>
        <li><a href="{{ "/guias/mantenimiento/" | relURL }}">Mantenimiento</a></li>
        <li><a href="{{ "/guias/seguridad/" | relURL }}">Seguridad</a></li>
      </ul>
    </section>

  {{ else }}

    {{/* =========================
        8) Estado noindex (sin data)
       ========================= */}}
    <section class="notice">
      <h2>Página en construcción</h2>
      <p>
        Esta URL existe para completar la estructura del sitio, pero aún no hay datos asociados
        (modelo no encontrado, categoría vacía o catálogo sin completar).
      </p>
      {{ if $modelSlug }}
        <p><a href="{{ (printf "/modelos/%s/" $modelSlug) | relURL }}">Volver al modelo</a></p>
      {{ else }}
        <p><a href="{{ "/modelos/" | relURL }}">Ver todos los modelos</a></p>
      {{ end }}
    </section>

  {{ end }}

{{ end }}
